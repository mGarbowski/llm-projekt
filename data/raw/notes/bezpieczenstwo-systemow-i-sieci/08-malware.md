# Malware

## Złośliwy kod
* Malware (malicious software)
	* wirusy robaki
	* specjalizowane oprogramowanie (budowa botnetów, skanowanie ofiar)
	* ransomware
* W dzisiejszym złośliwym kodzie nie ma jasnego podziału na funkcjonalności wirusa, robaka, backdooru itd.
* Najczęściej złośliwy kod zostaje uruchomiony bez wiedzy użytkownika
* Uruchomiony program może dokonać dowolnych zmian w systemie
* Jeśli cokolwiek złośliwego zostało uruchomione to należy wyczyścić maszynę
	* i najlepiej pozmieniać wszystkie hasła

## Podstawowe pojęcia
* Wirusy - samopropagujący się kod, do którego uruchomienia potrzebna jest interwencja użytkownika (włożenie dyskietki, włączenie makra itd)
	* infekcje boot-sectora nośnika
	* zainfekowane pliki wykonywalne
	* infekcje dysków flash
	* infekcje plików dokumentów (makra)
* Robak - samopropagujący się kod, do rozprzestrzeniania wykorzystujący sieć, nie potrzbuje interwencji użytkownika aby przenosić się między infekowanymi systemami
	* po infekcji maszyna samodzielnie zaczyna poszukiwać kolejnych ofiar i je infekować
* Backdoor - oprogramowanie umożliwiające zdalny dostęp do systemu nieautoryzowanym użytkownikom bez wiedzy administratora czy właściciela
* Koń trojański - oprogramowanie, które wydaje się mieć pożyteczne i niegroźne funkcje lecz posiadające ukryte nieznane osobie uruchamiającej działanie
	* najczęściej zawiera backdoor
* Spyware - oprogramowanie pisane w celu szpiegowania użytkownika komputera
	* loginy i hasła
	* naciskane klawisze (keylogger)
	* odwiedzane strony
	* adresaci, treści wysyłanych listów
	* dane na temat komputera, systemu operacyjnego, oprogramowania
* Ransomware - oprogramowanie, które blokuje dostęp do komputera lub danych w celu uzyskania okupu
	* winlocker - blokuje dostęp do maszyny
	* cryptolocker - szyfruje dane
* Exploit - specjalnie spreparowane dane umożliwiające wykorzystanie podatności
	* specjalnie spreparowany plik
	* żądanie do serwera
	* sesja komunikacyjna
	* dane wprowadzone przez użytkownika do aplikacji
* Shellcode
	* kawałek kodu maszynowego
	* najczęściej ściąga plik z internetu i uruchamia
	* niewielki program uruchamiany w wyniku wystąpienia błędu
	* ściąga malware (first stage)
	* dropper / downloader - wiele kroków programów pobierających programy przed pobraniem właściwego malware'u
	* mogą być często zmieniane żeby utrudnić wykrycie

## Rodzaje shellcode

### Port-bind, connect-back
* Uruchamia shella
* Tworzy gniazdo
	* nasłuchujące (port-bind)
	* łączące się pod wskazany adres (connect-back)
* Atakując podłącza się i wysyła komendy, które zostaną uruchomione

### Download and execute
* Instrukcje pozwalające ściągnąć dalsze stopnie robaka bezpośrednio w kodzie
* Wykorzystanie funkcji systemowych
	* URLDownloadToFile
	* CreateProcess
	* WinExec
* Program zapisany jako biblioteka, a nie wykonywalny

### Egg hunt
* Wykorzystywane kiedy bufory są za małe, żeby zmieścić całły exploit
* Umieszcza się fragmenty w oddzielnych kawałkach
* Ostatni fragment zbiera kawałki w jedno miejsce i je uruchamia
* Dzisiaj niepotrzebne, bo pamięci są większe

## Shellcode a zwykły program
* Nie jest normalnie ładowany do pamięci przez system operacyjny tylko wykorzystuje buffer overflow itd.
* Nie wiadomo pod jakim adresem będzie uruchomiony
* Problemy z ograniczeniami na znaki (np. nie może być bajtu `0x00`)
* Mały rozmiar
* Często zbiera się kawałki gotowców
* Kod uruchomiony pod nieznanym adresem
* Brak informacji gdzie znajdują się funkcje systemowe

## Uruchomienie programu w formacie PE
* Załadowanie segmentów kodu i danych pod odpowiednie adresy
* Odczytanie listy importowanych funkcji z systemowych bibliotek ładowanych dynamicznie
* Załadowanie wskazanych bibliotek dynamicznych do przestrzeni adresowej procesu
* Uaktualnienie adresów w tablicy importowanych funkcji

## Mechanizmy stosowane w shellcode
* Get PC - poznanie własnego adresu
	* wykorzystuje normalne działanie instrukcji call - wrzucanie adresu powrotu na stos
	* informacja często jest potrzebna do zdeszyfrowania dalszej części shellcodu
* Szyfrowanie
	* uniknięcie wykrycia
	* usunięcie nielegalnych znaków
	* najczęściej zwykłe xor
* Procedura odszukania struktur systemowych dotyczących danego procesu i wyszukanie adresów interesujących funkcji
	* każdy proces ma strukturę PEB
	* w niej jest adres pierwszej DLL
	* pierwsza DLL musi mieć procedurę ładowania biblioteki

### PEB
* Process Environment Block
* Struktura danych zawierająca wszystkie istotne informacje dotyczące danego procesu
* Umieszczona w przestrzeni adresowej procesu
* 13. 32-bitowe słowo wskazywane przez rejestr FS
* Pozwala uzyskać dostęp do listy załadowanych przez proces bibliotek
	* nazwy i adresy eksportowanych funkcji

## Motywacje atakujących
* Dawniej - pokazanie umiejętności itd.
* Obecnie - chęć zarobienia
	* głównym celem jest okradanie użytkowników lub wyłudzanie pieniędzy
* Należy patrzeć na atakujących jak na biznes
	* przeciwdziałanie to przede wszystkim podnoszenie ich kosztów

### Sposoby na zarabianie
* Dochody z reklam
	* właściciel botnetu zakłada stronę i umieszcza na niej płatne ogłoszenie
	* maszyny zombie klikają reklamy
* Wykorzystanie zainfekowanych maszyn do kopania kryptowalut
	* mało wydajne ale atakujący nie płaci za prąd i internet

## Botnet
* Jedna przejęta maszyna nie ma dużej wartości
* Kontrola nad setką, tysiącem maszyn już ma dużą wartość
	* więc każda maszyna w sieci ma wartość dla atakującego
	* każdą maszynę w sieci należy i warto chronić
* Bot, maszyna zombie - pojedynczy zainfekowany komputer, kontrolowany zdalnie
* Botmaster, serwer C&C (Command and Control)
	* maszyna dzięki której atakujący może kontrolować zainfekowane maszyny
* Botnet - wiele zainfekowanych maszyn pod kontrolą jednej osoby/organizacji
* Przykładowe komendy
	* wykonanie ataku DDoS
	* skanowanie w poszukiwaniu podatnych maszyn
	* uaktualnienie oprogramowania, pobranie dodatkowych narzędzi
* Zastosowania
	* rozsyłanie spamu
	* przprowadzanie ataków DDoS
	* zachęcanie do odwiedzania witryn
	* zdobywanie informacji o właścicielach zianfekowanych maszyn
	* wykradanie informaji
	* bezpośrednie zarabianie pieniędzy
* Komunikacja z serwerami C&C
	* IRC
	* pobieranie pliku komend z serwera
	* sieci peer-to-peer
	* sieć TOR
	* proste rozwiązania dalej są używane ze względu na niższe koszty

## Możliwości złośliwego oprogramowania
* Ukrywanie infekcji
	* uniemożliwia pozbycie się robaka
	* zabijanie procesów związanych z antywirusami, firewall itd.
	* przekierowywanie ruchu sieciowego antywirusów na adres loopback (plik `hosts`)
* Masowe infekowanie maszyn
	* auto-rooter
	* wykorzystują wiele podatności
	* funkcjonalnośc backdoor'a
* Logowanie naciskanych klawiszy
	* wykradanie loginów i haseł
* Dostęp do obrazu z kamery internetowej

## Zeus/Citadel
* Złośliwe oprogramowanie dedykowane wykradaniu informacji służących do logowania oraz danych finansowych
* Crime as a service
* Zawiera narzędzie umożliwiające personalizację trojana
* Wykradanie informacji z 
	* plików cookie przeglądarek i flash'a
	* klientów FTP
	* klientów pocztowych
* Man in the browser
	* system hooks w przeglądarce pozwalają wywołać funkcje systemu operacyjnego
	* umożliwia podsłuchiwanie komunikacje nawet przy szyfrowanym kanale
* Money mules

## Ransomware
* Złośliwe oprogramowanie blokujące dostęp do komputera i domagające się okupu
* Dwie wersje
	* blokująca dostęp do komputera - WinLocker
	* szyfrująca istotne dane ofiary (ew. groźba ich opublikowania) - CryptoLocker
* Dobry interes od czasu spopularyzowania się bitcoina do płatności
* Aktualnie najpopularniejszy sposób zarabiania
* Przy dobrym schemacie działania jest nie do złamania
